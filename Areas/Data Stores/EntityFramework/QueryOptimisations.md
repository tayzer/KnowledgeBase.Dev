# Entity Framework - Query Optimisations
Date: 2025-11-25
Status: ğŸŸ¢ Current
Tags: #ef-core #database #performance #sql #linq

## ğŸ¯ TL;DR / Quick Reference

**Definition:** Techniques to write LINQ and EF Core queries that translate efficiently to SQL and avoid common anti-patterns (N+1, client-eval).

**When to use:**
- High-throughput APIs and data-intensive operations.

**Key Takeaways:**
- âœ… **Use `.AsNoTracking()`** for read-only queries to reduce change-tracking overhead.
- âœ… **Project only required columns** with `Select` to reduce payload.
- âš ï¸ **Avoid N+1** by using `.Include()` or explicit joins when loading related data.

**Code Snippet:**
```csharp
var dtos = await _context.Orders
    .Where(o => o.Status == OrderStatus.Completed)
    .Select(o => new OrderDto { Id = o.Id, Total = o.Total })
    .ToListAsync();
```

**Gotchas:**
- âš ï¸ **Client-side evaluation:** Some methods cannot be translated to SQL and will cause data to be pulled into memory.
- âš ï¸ **Overuse of `.Include()`** can cause huge joins â€” prefer projection for complex graphs.

---

## ğŸ“š Deep Dive

### Common Anti-Patterns
- **N+1 Queries:** Multiple queries per item when lazy-loading related data. Fix with `Include` or explicit queries.
- **Pulling Whole Entities:** Using `ToList()` early or selecting full entities when only a few fields are needed.

### Translation Concerns
- Use only expressions that EF Core can translate. For unsupported functions, compute in query server-side equivalents or fetch minimal data and compute in memory.

### Performance Tips
- Use `Take`/`Skip` for pagination; avoid `Skip` on large offsets where possible (seek pagination preferred).
- Use database indexing aligned with query filters.
- Use `ExecuteSqlRaw` for very complex queries where translation is inefficient.

---

## ğŸ”— Related Concepts
- [[EntityFramework/MemoryAllocations]]
- [[Linq]]
- [[RepositoryUnitOfWork]]

## ğŸ“– Resources
- EF Core docs: performance
- Use Query Tags (`TagWith`) to help debugging generated SQL

## ğŸ§ª Practice Exercises
1. Find an endpoint that loads `Order -> OrderLines -> Product` and refactor to single projected query.
2. Measure SQL generated by LINQ queries using `ToQueryString()` and optimize.

## ğŸ“ Personal Notes

## ğŸ”„ Review Schedule
- [ ] Review in 3 months
